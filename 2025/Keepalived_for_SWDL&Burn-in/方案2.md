### 背景与挑战

您当前的架构将22个老化架（共1936个终端）分为3个子网，由3台主服务器和1台备用服务器提供PXE安装服务。核心挑战在于，当任何一台主服务器发生故障时，需要人工介入，手动配置和启用备用服务器，这不仅效率低下，还可能在紧急情况下导致大规模的安装中断。

### 核心优化目标

优化的核心目标是建立一个**自动化、高可用**的服务架构，实现：

1. **DHCP服务自动故障转移**：客户端始终能够获取IP地址，即使某台DHCP服务器宕机。  
2. **WDS/PXE服务自动故障转移**：客户端的PXE启动请求和系统镜像下载请求能够自动 перенаправляться (père-napravlyat'sya \- redirect) 到健康的服务器上。  
3. **性能负载均衡**：将1936个客户端的请求压力均匀分配到多台服务器上，加快整体部署速度。  
4. **简化管理**：集中管理系统镜像，避免在多台服务器上重复配置。

### 推荐架构：四节点高可用集群方案

我建议将现有的4台服务器整合为一个统一的高可用集群，共同为所有3个子网提供服务。该方案利用以下关键技术：

* **DHCP 故障转移 (DHCP Failover)**：实现DHCP服务的冗余和负载均衡。  
* **网络负载均衡 (Network Load Balancing, NLB)**：为WDS/PXE服务提供一个统一的虚拟IP地址，实现请求分发和故障转移。  
* **分布式文件系统 (Distributed File System, DFS)**：自动同步所有服务器上的Windows镜像文件，确保内容一致。

#### 架构示意图

\+--------------------------------------------------------------------------+  
|                                  子网 1, 2, 3                              |  
|                          (共 1936 个老化客户端)                            |  
\+--------------------------------------------------------------------------+  
       |  
       | DHCP & PXE 请求  
       v  
\+--------------------------------------------------------------------------+  
|      交换机/路由器 (配置了 DHCP 中继/IP Helper 指向所有4台服务器)        |  
\+--------------------------------------------------------------------------+  
       |  
       | 1\. DHCP请求被转发到所有4台服务器的物理IP  
       | 2\. PXE请求被定向到 NLB 虚拟IP (VIP)  
       v  
\+--------------------------------------------------------------------------+  
|                        NLB 虚拟IP (例如: 10.0.0.100)                       |  
\+--------------------------------------------------------------------------+  
       |                  ^                  ^                  ^  
       |                  |                  |                  |  
\+-------------+   \+-------------+   \+-------------+   \+-------------+  
|  服务器 1   |   |  服务器 2   |   |  服务器 3   |   |  服务器 4   |  
|-------------|   |-------------|   |-------------|   |-------------|  
| \- DHCP      |   | \- DHCP      |   | \- DHCP      |   | \- DHCP      |  
| \- WDS       |   | \- WDS       |   | \- WDS       |   | \- WDS       |  
| \- NLB 节点  |   | \- NLB 节点  |   | \- NLB 节点  |   | \- NLB 节点  |  
| \- DFS 节点  |   | \- DFS 节点  |   | \- DFS 节点  |   | \- DFS 节点  |  
\+-------------+   \+-------------+   \+-------------+   \+-------------+  
       ^                  ^                  ^                  ^  
       |\<----------------- DFS 复制 (同步 WDS 镜像) \----------------\>|  
       |  
       |\<----------------- DHCP 故障转移/负载均衡 \----------------\>|

### 实施步骤详解

#### 第一步：基础环境准备

1. **服务器配置**：为4台服务器配置静态IP地址。  
2. **安装角色**：在所有4台服务器上，通过服务器管理器安装以下角色和功能：  
   * DHCP 服务器  
   * Windows 部署服务 (WDS)  
   * 网络负载均衡 (NLB)  
   * DFS 复制 (DFS Replication)

#### 第二步：配置 DFS-R 实现镜像同步

1. **创建共享文件夹**：在每台服务器上，WDS会创建一个 REMINST 文件夹。确保这个文件夹的路径在所有服务器上保持一致。  
2. **创建复制组**：  
   * 打开“DFS 管理”工具。  
   * 新建一个“复制组”，选择“多用途复制组”。  
   * 将4台服务器添加为成员。  
   * 选择“完全网格”拓扑结构，这样任何一台服务器上的内容更新都会被复制到其他所有服务器。  
   * 将 REMINST 文件夹添加为要复制的文件夹。  
   * 完成向导后，DFS将开始在后台同步所有服务器的WDS镜像、驱动程序和启动文件。之后，您只需要在一台服务器上添加或更新镜像，它就会自动分发到所有服务器。

#### 第三步：配置 WDS 服务

在每台服务器上，独立配置WDS服务。由于DFS会保持REMINST文件夹的同步，所有服务器上的WDS配置和可用镜像将自动保持一致。

#### 第四步：配置 NLB 实现WDS/PXE高可用

1. **打开“网络负载均衡管理器”**。  
2. **新建群集**：  
   * 右键点击“网络负载均衡群集”，选择“新建群集”。  
   * 连接到第一台服务器，选择其用于群集通信的网卡。  
   * 在“群集IP地址”部分，添加一个**虚拟IP地址 (VIP)**。这个VIP将是所有PXE客户端的目标地址。请确保此VIP在您的网络中是唯一的且未被使用。  
   * 设置群集操作模式为“多播”。  
3. **添加节点**：右键点击创建好的群集，选择“将主机添加到群集”，然后依次将其余3台服务器添加进来。  
4. **配置端口规则**：为群集配置端口规则，确保WDS/PXE所需的流量（主要是TFTP的UDP端口69和WDS自身通信的端口）能够通过NLB进行分发。通常，默认的“所有端口”规则即可满足需求。

#### 第五步：配置 DHCP 实现高可用和负载均衡

1. **创建作用域**：在其中一台DHCP服务器上，为您的3个子网分别创建3个DHCP作用域。  
2. **配置故障转移**：  
   * 在IPv4上右键单击，选择“配置故障转移”。  
   * 选择要配置故障转移的作用域。  
   * 添加伙伴服务器。建议您创建两个故障转移对，例如：  
     * 服务器1 与 服务器2 建立故障转移关系。  
     * 服务器3 与 服务器4 建立故障转移关系。  
   * 选择模式为 **“负载均衡”**。当所有服务器都正常工作时，它们会共同分担DHCP请求压力。如果其中一台服务器宕机，其伙伴服务器会自动接管所有工作。  
3. **配置DHCP选项**：这是关键一步。在**所有3个作用域**中，配置以下两个选项：  
   * 066 启动服务器主机名：**将其值设置为您在第四步中创建的 NLB 虚拟IP (VIP)**。  
   * 067 启动文件名：根据您的固件类型设置，例如 boot\\x64\\wdsmgfw.efi (适用于UEFI) 或 boot\\x64\\wdsnbp.com (适用于Legacy BIOS)。

#### 第六步：配置网络交换机

在负责连接这3个子网的核心交换机或路由器上，配置 **DHCP 中继 (或称为 IP Helper)**。将中继地址设置为**所有4台服务器的物理IP地址**。这样，任何子网中的客户端发出的DHCP广播请求，都会被交换机转发到所有4台DHCP服务器，从而激活DHCP故障转移/负载均衡机制。

### 新架构的优势总结

1. **完全自动化的故障转移**：  
   * **DHCP**：任何一台DHCP服务器故障，其伙伴服务器会无缝接管，客户端获取IP不受影响。  
   * **WDS/PXE**：任何一台WDS服务器故障，NLB会自动检测到并停止向其发送流量，将所有PXE请求重定向到其他健康的服务器上。整个过程无需人工干预。  
2. **卓越的性能和负载均衡**：  
   * 近2000台客户端同时安装时，请求压力被均匀地分散到4台服务器上，显著减少了单台服务器的瓶颈，提升了整体部署效率。  
3. **极简的管理**：  
   * 系统镜像和驱动程序只需通过DFS在一个地方管理，即可自动同步到所有节点。  
   * 所有客户端都指向同一个NLB虚拟地址，配置简单统一。  
4. **高可扩展性**：  
   * 如果未来需要支持更多客户端，只需将新服务器加入到DFS复制组和NLB群集中即可，轻松实现横向扩展。

通过以上方案，您可以将原先需要手动维护的系统，升级为一个健壮、高效、自动化的企业级部署平台。

```mermaid
graph TD
    %% 客户端子网
    subgraph 客户端子网["客户端子网 (22个老化架，1936个终端)"]
        direction TB
        Client1[子网1客户端] <--> Switch1[老化架交换机]
        Client2[子网2客户端] <--> Switch2[老化架交换机]
        Client3[子网3客户端] <--> Switch3[老化架交换机]
    end

    %% 核心网络设备
    CoreRouter[[核心交换机/路由器<br/>DHCP中继配置]]
    
    %% 高可用集群
    subgraph 服务器集群["四节点高可用集群"]
        direction TB
        VIP[("NLB 虚拟IP<br/>10.0.0.100")]
        
        subgraph 服务器1
            S1[物理IP:10.0.0.1] --- DHCP1[DHCP服务]
            S1 --- WDS1[WDS/PXE]
            S1 --- NLB1[NLB节点]
            S1 --- DFS1[DFS节点]
        end
        
        subgraph 服务器2
            S2[物理IP:10.0.0.2] --- DHCP2[DHCP服务]
            S2 --- WDS2[WDS/PXE]
            S2 --- NLB2[NLB节点]
            S2 --- DFS2[DFS节点]
        end
        
        subgraph 服务器3
            S3[物理IP:10.0.0.3] --- DHCP3[DHCP服务]
            S3 --- WDS3[WDS/PXE]
            S3 --- NLB3[NLB节点]
            S3 --- DFS3[DFS节点]
        end
        
        subgraph 服务器4
            S4[物理IP:10.0.0.4] --- DHCP4[DHCP服务]
            S4 --- WDS4[WDS/PXE]
            S4 --- NLB4[NLB节点]
            S4 --- DFS4[DFS节点]
        end
    end

    %% 连接流程
    Switch1 & Switch2 & Switch3 -->|DHCP广播请求| CoreRouter
    CoreRouter -->|DHCP中继转发| DHCP1 & DHCP2 & DHCP3 & DHCP4
    DHCP1 & DHCP2 & DHCP3 & DHCP4 -->|DHCP响应含VIP| CoreRouter
    CoreRouter -->|分配IP地址| Client1 & Client2 & Client3
    
    Client1 & Client2 & Client3 -->|PXE启动请求| VIP
    VIP -->|负载均衡| WDS1 & WDS2 & WDS3 & WDS4
    
    %% 后台同步
    DFS1 <-->|DFS镜像同步| DFS2
    DFS1 <-->|DFS镜像同步| DFS3
    DFS1 <-->|DFS镜像同步| DFS4
    DFS2 <-->|DFS镜像同步| DFS3
    DFS2 <-->|DFS镜像同步| DFS4
    DFS3 <-->|DFS镜像同步| DFS4
    
    DHCP1 <-->|故障转移对| DHCP2
    DHCP3 <-->|故障转移对| DHCP4

    %% 样式定义
    linkStyle 0,1,2,3,4,5,6,7,8,9,10,11 stroke:#007BFF,stroke-width:2px
    linkStyle 12,13,14,15,16,17,18,19 stroke:#28A745,stroke-width:2px,stroke-dasharray:5 5
    linkStyle 20,21,22,23,24,25 stroke:#DC3545,stroke-width:2px